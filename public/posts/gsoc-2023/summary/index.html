<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>GSOC-2023: summary - marinegor.dev</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="As you might know from my previous posts, during the summer of 2023 I&rsquo;ve been working on MDAnalysis&rsquo;s project during Google Summer of Code. Here I&rsquo;ll summarize what I&rsquo;ve done, how others can use it, and what changes will follow that in the MDAnalysis codebase in the near future.
A short description of the goals of the project. One sentence: introduce parallel execution of analysis runs in MDAnalysis library. Somewhat good introduction I also gave here when writing a proposal for the project." />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="http://localhost:1313/posts/gsoc-2023/summary/">
  <meta property="og:site_name" content="marinegor.dev">
  <meta property="og:title" content="GSOC-2023: summary">
  <meta property="og:description" content="As you might know from my previous posts, during the summer of 2023 I’ve been working on MDAnalysis’s project during Google Summer of Code. Here I’ll summarize what I’ve done, how others can use it, and what changes will follow that in the MDAnalysis codebase in the near future.
A short description of the goals of the project. One sentence: introduce parallel execution of analysis runs in MDAnalysis library. Somewhat good introduction I also gave here when writing a proposal for the project.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-08-23T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-08-23T00:00:00+00:00">
    <meta property="article:tag" content="Gsoc">
    <meta property="article:tag" content="Coding">
    <meta property="article:tag" content="Mdanalysis">
    <meta property="article:tag" content="Clean Code">
    <meta property="article:tag" content="Projects">
<meta name="twitter:card" content="summary"><meta name="twitter:title" content="GSOC-2023: summary">
<meta name="twitter:description" content="As you might know from my previous posts, during the summer of 2023 I&rsquo;ve been working on MDAnalysis&rsquo;s project during Google Summer of Code. Here I&rsquo;ll summarize what I&rsquo;ve done, how others can use it, and what changes will follow that in the MDAnalysis codebase in the near future.
A short description of the goals of the project. One sentence: introduce parallel execution of analysis runs in MDAnalysis library. Somewhat good introduction I also gave here when writing a proposal for the project.">
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css" media="(prefers-color-scheme: dark)"  />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>
	
		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
		
		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">marinegor.dev</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		<a href="/tags">Tags</a>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">GSOC-2023: summary</h1>
			<div class="meta">Posted on Aug 23, 2023</div>
		</div>
		

		<section class="body">
			<p>As you might know from my previous posts, during the summer of 2023 I&rsquo;ve been working on MDAnalysis&rsquo;s project during Google Summer of Code. Here I&rsquo;ll summarize what I&rsquo;ve done, how others can use it, and what changes will follow that in the MDAnalysis codebase in the near future.</p>
<h2 id="a-short-description-of-the-goals-of-the-project">A short description of the goals of the project.</h2>
<p>One sentence: introduce parallel execution of analysis runs in <a href="https://github.com/MDAnalysis/mdanalysis">MDAnalysis</a> library. Somewhat good introduction I also gave <a href="https://marinegor.github.io/posts/2023/05/gsoc-proposal/">here</a> when writing a proposal for the project.</p>
<p>In more technical details, MDAnalysis library (as of v2.6.0) contains around 30 different subclasses that can perform various molecular trajectory analysis tasks, like calculating RMSD, RMSF, various contacts, density analysis, and more advanced tasks. 24 of these subclasses are children of <code>AnalysisBase</code> class. This base class is written in a way that allows subclass authors care about implementing only 3 methods:</p>
<ol>
<li><code>_prepare()</code> &ndash; how to initialize attributes for the analysis</li>
<li><code>_single_frame()</code> &ndash; how to do analysis of a single molecular trajectory frame</li>
<li><code>_conclude()</code> &ndash; how to transform intermediate results into final ones</li>
</ol>
<p>With only these 3 methods implemented, by inheritance subclasses get <code>run()</code> method that will take care of reading the trajectory, storing the results, logging, etc.</p>
<p>The main goal was to re-write <code>AnalysisBase.run()</code> so that it can run in parallel on multiple processes, but make these changes invisible from the subclasses, i.e. not re-write any of their code.</p>
<h2 id="what-you-did">What you did.</h2>
<p>Altogether, the <code>AnalysisBase.run()</code> has changed by addition of the following methods:</p>
<ul>
<li><code>_setup_computation_groups()</code>: split frames into multiple parts for separate analysis</li>
<li><code>_compute()</code>: run <code>_single_frame</code> on a list of frames, but without running <code>_conclude</code></li>
<li><code>_get_aggregator()</code>: get an object to aggregate the run results with, making them compatible with subsequent <code>_conclude</code></li>
<li>class property <code>available_backends()</code>: get list of <code>str</code> values that describe available backends for a given subclass</li>
</ul>
<p>I&rsquo;ve also added <code>ParallelExecutor</code> and <code>ResultsGroup</code> classes that abstract away parallel execution and results aggregation, respectively. And finally, I added <code>multiprocessing</code> and <code>dask</code>/<code>dask.distributed</code> backends that reportedly speed up the analysis!</p>
<h2 id="the-current-state">The current state.</h2>
<p>Currently, changes to the <code>AnalysisBase</code> are almost finalized. One thing that holds it back is some CI/CD issues causing tests to timeout, but all <code>AnalysisBase</code>-related tests run both locally and on CI/CD system.</p>
<h2 id="whats-left-to-do">What&rsquo;s left to do.</h2>
<p>Optional thing suggested within my proposal was to actually add parallelization to the subclasses, and update tests accordingly. It turned out to be a tedious task, but finally the mechanism is finalized and described in <code>MDAnalysisTests/analysis/conftest.py</code>. It automatically generates each subclass fixtures for testing, and updating tests accordingly is fairly simple yet tedious. After updating all the tests, the library will be fully equipped with the parallel execution mechanisms for those classes that allow it.</p>
<h2 id="what-code-got-merged-or-not-upstream">What code got merged (or not) upstream.</h2>
<p>The main changes are summarized in the <a href="https://github.com/MDAnalysis/mdanalysis/pull/4162">main pull-request</a> of the project. They mostly involve changes to <code>package/analysis/base.py</code>, as well as installation and CI/CD configuration files. Also, there are example changes in <code>package/analysis/rms.py</code> introducing parallelization into RMSD and RMSF subclasses, showcasing the changes to be made in order to add parallelization to a certain class.</p>
<h2 id="how-others-can-use-it">How others can use it</h2>
<p>Let&rsquo;s imagine we&rsquo;ve just learned that MDAnalysis now supports paralleization, and want to calculate RMSD of our large trajectory faster using multiple cores on our machine. Imagine we have a 16-core CPU Linux workstation with an SSD drive and a 1 us trajectory of lysozyme in water. Like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> MDAnalysis <span style="color:#66d9ef">as</span> mda
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> MDAnalysis.analysis <span style="color:#f92672">import</span> rms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./large_data/&#34;</span>
</span></span><span style="display:flex;"><span>traj, top <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>prefix<span style="color:#e6db74">}</span><span style="color:#e6db74">/md_0_1.xtc&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>prefix<span style="color:#e6db74">}</span><span style="color:#e6db74">/md_0_1.gro&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>u <span style="color:#f92672">=</span> mda<span style="color:#f92672">.</span>Universe(top, traj)
</span></span></code></pre></div><p>First we want to get a reference structure by taking the average of all frames. Like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> MDAnalysis.analysis.align <span style="color:#f92672">import</span> AverageStructure
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>avg <span style="color:#f92672">=</span> AverageStructure(mobile<span style="color:#f92672">=</span>u)<span style="color:#f92672">.</span>run(backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;multiprocessing&#39;</span>, n_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)
</span></span></code></pre></div><p>but we get this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">ValueError</span>                                Traceback (most recent call last)
</span></span><span style="display:flex;"><span>Cell In[<span style="color:#ae81ff">11</span>], line <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> <span style="color:#f92672">from</span> MDAnalysis.analysis.align <span style="color:#f92672">import</span> AverageStructure
</span></span><span style="display:flex;"><span><span style="color:#f92672">----&gt;</span> <span style="color:#ae81ff">2</span> avg <span style="color:#f92672">=</span> AverageStructure(mobile<span style="color:#f92672">=</span>u)<span style="color:#f92672">.</span>run(backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;multiprocessing&#39;</span>, n_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ValueError</span>: backend<span style="color:#f92672">=</span>multiprocessing <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>available_backends<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;local&#39;</span>,) <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AverageStructure</span>
</span></span></code></pre></div><p>which basically says we can use only <code>backend='local'</code> for the <code>AverageStructure</code>. Ok, let&rsquo;s do that, but with a large step to save time:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>avg <span style="color:#f92672">=</span> AverageStructure(mobile<span style="color:#f92672">=</span>u)<span style="color:#f92672">.</span>run(step<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>ref <span style="color:#f92672">=</span> avg<span style="color:#f92672">.</span>results<span style="color:#f92672">.</span>universe
</span></span></code></pre></div><p>and start our analysis run &ndash; RMSD for multiple selections to later compare them between each other:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>groupselections <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;protein&#34;</span>, <span style="color:#e6db74">&#34;backbone&#34;</span>, <span style="color:#e6db74">&#34;name CA&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>R <span style="color:#f92672">=</span> rms<span style="color:#f92672">.</span>RMSD(
</span></span><span style="display:flex;"><span>    u,  <span style="color:#75715e"># universe to align</span>
</span></span><span style="display:flex;"><span>    ref,  <span style="color:#75715e"># reference universe or atomgroup</span>
</span></span><span style="display:flex;"><span>    groupselections<span style="color:#f92672">=</span>groupselections,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># select=&#34;backbone&#34;,  # group to superimpose and calculate RMSD</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>If we start it with <code>R.run()</code>, we won&rsquo;t even know when the run would finish. Luckily, we can add some verbosity with <code>R.run(verbose=True)</code> and see a nice <code>tqdm</code> progressbar that shows us that ETA of the whole analysis is around 4 minutes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> R<span style="color:#f92672">.</span>run(verbose<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span><span style="color:#f92672">%|</span><span style="color:#960050;background-color:#1e0010">▌</span>         <span style="color:#f92672">|</span> <span style="color:#ae81ff">5062</span><span style="color:#f92672">/</span><span style="color:#ae81ff">100001</span> [<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">13</span><span style="color:#f92672">&lt;</span><span style="color:#ae81ff">04</span>:<span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">371.20</span>it<span style="color:#f92672">/</span>s]
</span></span></code></pre></div><p>let&rsquo;s try to speed it up now. Which backends do we have available?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> rms<span style="color:#f92672">.</span>RMSD<span style="color:#f92672">.</span>available_backends
</span></span><span style="display:flex;"><span>(<span style="color:#e6db74">&#39;local&#39;</span>, <span style="color:#e6db74">&#39;multiprocessing&#39;</span>, <span style="color:#e6db74">&#39;dask&#39;</span>, <span style="color:#e6db74">&#39;dask.distributed&#39;</span>)
</span></span></code></pre></div><p>let&rsquo;s try a built-in <code>multiprocessing</code> first:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> R<span style="color:#f92672">.</span>run(backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;multiprocessing&#39;</span>, n_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CPU times: user 153 ms, sys: 74.2 ms, total: 227 ms</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wall time: 1min 14s</span>
</span></span></code></pre></div><p>ok, this is roughly 4 times faster! Amazing, roughly as we expected.
Spoiler though &ndash; if we do it with 16 workers, we&rsquo;ll see the total time around 40 seconds, so improvement saturates at some point.</p>
<p>But, we&rsquo;ve lost something valuable when switching to <code>multiprocessing</code> &ndash; we don&rsquo;t have a decent progressbar anymore. Luckily, we can use an amazing <code>dask</code> dashboard that allows us to monitor all tasks given to a particular <code>dask.distributed</code> cluster!</p>
<p>Let&rsquo;s set up a cluster first:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> dask.distributed <span style="color:#f92672">import</span> Client, LocalCluster
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cluster <span style="color:#f92672">=</span> LocalCluster(n_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>, 
</span></span><span style="display:flex;"><span>                       threads_per_worker<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                       memory_limit<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;30Gb&#39;</span>)
</span></span><span style="display:flex;"><span>client <span style="color:#f92672">=</span> Client(cluster)
</span></span></code></pre></div><p>and open the dashboard in our browser:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> cluster<span style="color:#f92672">.</span>dashboard_link
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;http://127.0.0.1:8787/status&#39;</span>
</span></span></code></pre></div><p>Now, we&rsquo;re ready to pass the pre-configured <code>client</code> as an argument to our <code>R.run()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>R<span style="color:#f92672">.</span>run(client<span style="color:#f92672">=</span>client)
</span></span></code></pre></div><p>unfortunately, we won&rsquo;t see much progress &ndash; we can see that all tasks got spawned, but their status will change only upon completion, and we won&rsquo;t get any intermediate progress report.</p>
<p>But luckily, there is a way to control that: in <code>R.run()</code> function, you can split the workload into an arbitrary number of parts with <code>n_parts = ...</code>, and upon completion of each of them <code>dask</code> would report that. Let&rsquo;s do this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>R<span style="color:#f92672">.</span>run(client<span style="color:#f92672">=</span>client, n_parts<span style="color:#f92672">=</span><span style="color:#ae81ff">96</span>)
</span></span></code></pre></div><p>now we&rsquo;ll see intermediate progress as well as soon as each part gets completed, which is super helpful when trying to estimate the completion time.</p>
<h2 id="conclusion">Conclusion</h2>
<p>We&rsquo;ve now went through the essense of the MDAnalysis parallelization project, and learned how to use it in your analysis either by simply adding <code>backend='multiprocessing', n_workers=...</code>, or setting up your own <code>dask</code> cluster and submitting your jobs there.</p>
<p>Hopefully, this project will grow further and include all existing subclasses, as well as improving the speed (which, as we saw, saturates) and memory efficiency.</p>
<p>If you want to contribute to the project, stay tuned for the new issues on MDAnalysis <a href="https://github.com/MDAnalysis/mdanalysis">github</a> &ndash; there definitely will be some parallelization-related things for the future described there!</p>

		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/gsoc">gsoc</a></li>
					
					<li><a href="/tags/coding">coding</a></li>
					
					<li><a href="/tags/mdanalysis">mdanalysis</a></li>
					
					<li><a href="/tags/clean-code">clean code</a></li>
					
					<li><a href="/tags/projects">projects</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/marinegor" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a><a class="soc" href="https://twitter.com/egor__marin/" rel="me" title="Twitter"><i data-feather="twitter"></i></a>
    <a class="border"></a><a class="soc" href="https://www.linkedin.com/in/marinegor/" rel="me" title="Linkedin"><i data-feather="linkedin"></i></a>
    <a class="border"></a><a class="soc" href="https://bsky.app/profile/marinegor.bsky.social" rel="me" title="Bluesky"><i data-feather="bluesky"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  Egor Marin |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
